- name: SSD Wearout Report
  hosts: all
  gather_facts: false
  become: true

  vars:
    discord_webhook_url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
    sata_device: /dev/sdh
    nvme_devices:
      - nvme0n1
      - nvme1n1
      - nvme2n1

  environment:
    PYTHONWARNINGS: "ignore"

  tasks:
    - name: Init disk report list
      set_fact:
        disk_reports: []

    ####################
    # SATA SSD
    ####################
    - name: Check SATA device exists
      stat:
        path: "{{ sata_device }}"
      register: sata_stat

    - name: Collect SATA SSD info
      when: sata_stat.stat.exists
      block:
        - name: Read SATA info
          command: smartctl -i {{ sata_device }}
          register: sata_info
          changed_when: false

        - name: Read SATA wearout
          command: smartctl -A {{ sata_device }}
          register: sata_attr
          changed_when: false

        - name: Append SATA report
          set_fact:
            disk_reports: "{{ disk_reports + [ sata_report ] }}"
          vars:
            sata_report: |
              **SATA SSD**
              Model: {{ sata_info.stdout | regex_search('Device Model:\\s*(.*)', '\\1') | default('Unknown') }}
              Serial: {{ sata_info.stdout | regex_search('Serial Number:\\s*(.*)', '\\1') | default('Unknown') }}
              Wearout Remaining: {{ sata_attr.stdout | regex_search('Media_Wearout_Indicator\\s+\\S+\\s+\\S+\\s+(\\d+)', '\\1') | default('Unavailable') }}%

    - name: Append SATA not found
      when: not sata_stat.stat.exists
      set_fact:
        disk_reports: "{{ disk_reports + [ '**SATA SSD**\nDevice not found.' ] }}"

    ####################
    # NVMe SSDs
    ####################
    - name: Process NVMe devices
      loop: "{{ nvme_devices }}"
      loop_control:
        loop_var: nvme
      block:
        - name: Check NVMe exists
          stat:
            path: "/dev/{{ nvme }}"
          register: nvme_stat

        - name: Collect NVMe info
          when: nvme_stat.stat.exists
          block:
            - command: smartctl -i /dev/{{ nvme }}
              register: nvme_info
              changed_when: false

            - command: smartctl -a /dev/{{ nvme }}
              register: nvme_attr
              changed_when: false

            - name: Append NVMe report
              set_fact:
                disk_reports: "{{ disk_reports + [ nvme_report ] }}"
              vars:
                used_pct: "{{ nvme_attr.stdout | regex_search('Percentage Used:\\s*(\\d+)', '\\1') | default('0') | int }}"
                nvme_report: |
                  **NVMe {{ nvme }}**
                  Model: {{ nvme_info.stdout | regex_search('Model Number:\\s*(.*)', '\\1') | default('Unknown') }}
                  Serial: {{ nvme_info.stdout | regex_search('Serial Number:\\s*(.*)', '\\1') | default('Unknown') }}
                  Wearout Remaining: {{ 100 - used_pct }}%

        - name: Append NVMe not found
          when: not nvme_stat.stat.exists
          set_fact:
            disk_reports: "{{ disk_reports + [ '**NVMe ' ~ nvme ~ '**\nDevice not found.' ] }}"

    ####################
    # Send Discord message (1 per host)
    ####################
    - name: Send SSD wearout report to Discord
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          content: |
            üñ•Ô∏è **SSD Wearout Report**
            Host: **{{ inventory_hostname }}**

            {{ disk_reports | join('\n\n') }}
      status_code: 204
