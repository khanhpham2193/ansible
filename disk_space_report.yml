---
- name: Collect disk usage from all hosts
  hosts: all
  gather_facts: false
  become: false

  tasks:
    - name: Get root disk usage percentage
      ansible.builtin.shell: |
        df -h / | awk 'NR==2 {gsub("%",""); print $5}'
      register: disk_usage
      changed_when: false

    - name: Save disk usage fact
      ansible.builtin.set_fact:
        root_disk_usage: "{{ disk_usage.stdout | int }}"

- name: Send aggregated disk report to Discord
  hosts: localhost
  gather_facts: false

  vars:
    discord_webhook_url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"

  environment:
    PYTHONWARNINGS: "ignore"

  tasks:
    - name: Fail if DISCORD_WEBHOOK_URL is not set
      ansible.builtin.fail:
        msg: "DISCORD_WEBHOOK_URL environment variable is not set"
      when: discord_webhook_url is not defined or discord_webhook_url | length == 0

    - name: Build aggregated disk usage report
      ansible.builtin.set_fact:
        discord_message: |
          ðŸ“Š **Disk Usage Summary (/)**
          {% for host in groups['all'] %}
          {% set usage = hostvars[host].root_disk_usage | default(-1) %}
          {% if usage >= 80 %}
          ðŸ”´ **{{ host }}** : {{ usage }}%
          {% else %}
          ðŸŸ¢ {{ host }} : {{ usage }}%
          {% endif %}
          {% endfor %}

    - name: Send aggregated report to Discord
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          content: "{{ discord_message }}"
        status_code: 204
