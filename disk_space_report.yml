- name: Disk usage alert to Discord
  hosts: localhost
  gather_facts: false

  vars:
    discord_webhook_url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
    disk_threshold: 80

  environment:
    PYTHONWARNINGS: "ignore"

  tasks:
    - name: Init high disk host list
      set_fact:
        high_disk_hosts: []

    - name: Collect hosts over disk threshold
      set_fact:
        high_disk_hosts: "{{ high_disk_hosts + [item] }}"
      loop: "{{ groups['all'] }}"
      when:
        - hostvars[item].root_disk_usage is defined
        - hostvars[item].root_disk_usage | int >= disk_threshold

    - name: Build alert message
      set_fact:
        alert_message: |
          ðŸš¨ **Disk Usage Alert (>= {{ disk_threshold }}%)**
          {% for h in high_disk_hosts %}
          â€¢ **{{ hostvars[h].host_name | default(h) }}**
            IP: {{ h }}
            Disk: {{ hostvars[h].root_disk_usage }}%
          {% endfor %}

    - name: Send OK message if no host exceeds threshold
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          content: "âœ… All hosts are below {{ disk_threshold }}% disk usage. No action required."
        status_code: 204
      when: high_disk_hosts | length == 0

    - name: Send alert message if disk issue detected
      ansible.builtin.uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          content: "{{ alert_message }}"
        status_code: 204
      when: high_disk_hosts | length > 0
